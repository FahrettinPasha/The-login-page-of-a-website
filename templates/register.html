<!DOCTYPE html>
<html>
<head>
    <title>Kayıt Ol</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    {# intl-tel-input CSS #}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    {# Leaflet.js Harita Kütüphanesi CSS #}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        xintegrity="sha512-xodxCoA9dF36+iS29kX4n59tA7jL/V7k7C2/m5j6g8u4q5z3e6p7S+F+D+d+M+a+C+P+y3J+iQ=="
        crossorigin=""/>
    <style>
        .password-group {
            position: relative;
        }
        .input-group input[type="password"] {
            padding-right: 35px; /* İkonlar için boşluk bırakma */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Kayıt Formu</h1>
        {# Flash mesajları burada gösterilir #}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flashes">
                {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}
        <form id="registerForm" action="/kayit" method="POST">
            <div class="input-group">
                <input type="text" id="ad" name="ad" placeholder="Adınız" required value="{{ form_data.ad if form_data else '' }}">
                <div class="input-feedback-icon"></div>
            </div>
            <div class="input-group">
                <input type="text" id="soyad" name="soyad" placeholder="Soyadınız" required value="{{ form_data.soyad if form_data else '' }}">
                <div class="input-feedback-icon"></div>
            </div>
            <div class="input-group">
                <input type="text" id="username" name="username" placeholder="Kullanıcı Adı" required value="{{ form_data.username if form_data else '' }}">
                <div class="input-feedback-icon"></div>
            </div>
            <div class="input-group">
                <input type="email" id="email" name="email" placeholder="E-posta" required value="{{ form_data.email if form_data else '' }}">
                <div class="input-feedback-icon"></div>
            </div>
            <div class="input-group password-group">
                <input type="password" id="sifre" name="sifre" placeholder="Şifre (min 8 karakter, B/k harf, rakam, özel)" required minlength="8">
                <span class="toggle-password" onclick="togglePassword('sifre')">
                    <svg class="eye-icon" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <svg class="eye-off-icon" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
                        <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.94 3.06M2 2l20 20"></path>
                    </svg>
                </span>
                <div class="input-feedback-icon"></div>
            </div>
            <div id="password-strength-feedback" class="password-feedback hidden"></div>
            <div class="password-strength-bar-container hidden">
                <div id="password-strength-bar" class="password-strength-bar"></div>
            </div>
            <div class="input-group password-group">
                <input type="password" id="confirm_sifre" name="confirm_sifre" placeholder="Şifrenizi Tekrar Girin" required minlength="8">
                <span class="toggle-password" onclick="togglePassword('confirm_sifre')">
                    <svg class="eye-icon" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <svg class="eye-off-icon" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
                        <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.94 3.06M2 2l20 20"></path>
                    </svg>
                </span>
                <div class="input-feedback-icon"></div>
            </div>
            <div class="input-group phone-input-container">
                <input type="tel" id="telefon" name="telefon" placeholder="Telefon Numarası (örn: 5xx xxx xx xx)" required value="{{ form_data.telefon if form_data else '' }}">
                <div class="input-feedback-icon"></div>
            </div>
            <div class="input-group">
                <input type="text" id="tc_no" name="tc_no" placeholder="TC Kimlik No (11 haneli)" required pattern="[0-9]{11}" title="TC Kimlik No 11 haneli olmalı ve sadece rakamlardan oluşmalıdır." value="{{ form_data.tc_no if form_data else '' }}">
                <div class="input-feedback-icon"></div>
            </div>
            <div class="input-group">
                <input type="date" id="dogum_tarihi" name="dogum_tarihi" placeholder="Doğum Tarihi" required value="{{ form_data.dogum_tarihi if form_data else '' }}">
                <div class="input-feedback-icon"></div>
            </div>
            <div class="input-group address-group">
                <textarea id="adres" name="adres" placeholder="Adres">{{ form_data.adres if form_data else '' }}</textarea>
                <button type="button" id="showMapBtn" class="show-map-btn">Haritada Göster</button>
                <div class="input-feedback-icon"></div>
            </div>
            <div class="input-group">
                <select id="cinsiyet" name="cinsiyet" required>
                    <option value="" disabled {% if not form_data.cinsiyet %}selected{% endif %}>Cinsiyet Seçin</option>
                    <option value="erkek" {% if form_data.cinsiyet == 'erkek' %}selected{% endif %}>Erkek</option>
                    <option value="kadın" {% if form_data.cinsiyet == 'kadın' %}selected{% endif %}>Kadın</option>
                </select>
                <div class="input-feedback-icon"></div>
            </div>
            
            <div class="g-recaptcha" data-sitekey="YOUR_RECAPTCHA_SITE_KEY"></div>
            <button type="submit">Kayıt Ol</button>
        </form>
        <p>Zaten hesabınız var? <a href="/giris">Giriş Yapın</a></p>
    </div>

    <!-- Harita Paneli -->
    <div id="mapPanel" class="map-panel hidden">
        <div class="map-content">
            <button id="closeMapBtn" class="close-map-btn">&times;</button>
            <div class="map-controls">
                <input type="text" id="mapAddressSearch" placeholder="Adres Ara">
                <button id="searchMapBtn">Haritada Göster</button>
            </div>
            <button id="findMeBtn" class="find-me-btn">Konumumu Bul</button>
            <div id="map" class="map-container"></div>
            <div class="map-address-info">
                <p><strong>Bulunan Adres:</strong></p>
                <textarea id="foundAddress" rows="3" readonly></textarea>
                <button id="selectAddressBtn" class="select-address-btn">Tamam</button>
            </div>
        </div>
    </div>

    {# intl-tel-input JavaScript #}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
    {# Leaflet.js Harita Kütüphanesi JavaScript #}
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        xintegrity="sha512-wt3eFwXpA5C1p4F2t9W3K9m/eF1d6q2g4G7n4C9z9e2k9g9r1y4u8+2w8a4o8/2n/04j01n+f0g=="
        crossorigin=""></script>
    <script>
        // intl-tel-input başlatılıyor
        const phoneInputField = document.getElementById("telefon");
        const iti = window.intlTelInput(phoneInputField, {
            utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
            initialCountry: "tr",
            onlyCountries: ["tr"],
            separateDialCode: false,
            dropdownContainer: document.body,
        });

        if (phoneInputField.value) {
            iti.setNumber(phoneInputField.value);
        }

        // Şifre gücü kontrolü için JavaScript
        const passwordInput = document.getElementById('sifre');
        const confirmPasswordInput = document.getElementById('confirm_sifre');
        const passwordFeedback = document.getElementById('password-strength-feedback');
        const passwordStrengthBarContainer = document.querySelector('.password-strength-bar-container');
        const passwordStrengthBar = document.getElementById('password-strength-bar');
        const passwordIcon = passwordInput.closest('.input-group').querySelector('.input-feedback-icon');
        const confirmPasswordIcon = confirmPasswordInput.closest('.input-group').querySelector('.input-feedback-icon');

        function updatePasswordStrength() {
            const password = passwordInput.value;
            
            if (password.length === 0) {
                passwordFeedback.classList.add('hidden');
                passwordStrengthBarContainer.classList.add('hidden');
                passwordIcon.classList.remove('valid-icon', 'invalid-icon');
                passwordIcon.textContent = '';
                return;
            } else {
                passwordFeedback.classList.remove('hidden');
                passwordStrengthBarContainer.classList.remove('hidden');
            }

            let strength = 0;
            let feedbackText = '';
            let feedbackClass = '';
            let barWidth = 0;

            const hasMinLength = password.length >= 8;
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasDigit = /[0-9]/.test(password);
            const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(password);

            if (hasMinLength) strength++;
            if (hasUpperCase) strength++;
            if (hasLowerCase) strength++;
            if (hasDigit) strength++;
            if (hasSpecialChar) strength++;

            if (strength < 3) {
                feedbackText = 'Şifre çok zayıf! (En az 8 karakter, B/k harf, rakam, özel karakter içermeli)';
                feedbackClass = 'weak';
                barWidth = (strength / 5) * 100;
                passwordIcon.classList.remove('valid-icon');
                passwordIcon.classList.add('invalid-icon');
                passwordIcon.textContent = '✕';
            } else if (strength >= 3 && strength <= 5) {
                feedbackText = strength === 5 ? 'Şifre güçlü!' : 'Şifre orta güçlükte.';
                feedbackClass = strength === 5 ? 'strong' : 'medium';
                barWidth = (strength / 5) * 100;
                passwordIcon.classList.remove('invalid-icon');
                passwordIcon.classList.add('valid-icon');
                passwordIcon.textContent = '✓';
            }

            passwordFeedback.textContent = feedbackText;
            passwordFeedback.className = 'password-feedback ' + feedbackClass;

            passwordStrengthBar.style.width = barWidth + '%';
            passwordStrengthBar.className = 'password-strength-bar ' + feedbackClass;
        }

        function validateConfirmPassword() {
            if (confirmPasswordInput.value.length === 0) {
                confirmPasswordInput.classList.remove('is-valid', 'is-invalid');
                confirmPasswordIcon.classList.remove('valid-icon', 'invalid-icon');
                confirmPasswordIcon.textContent = '';
                return;
            }

            if (passwordInput.value === confirmPasswordInput.value) {
                confirmPasswordInput.classList.remove('is-invalid');
                confirmPasswordInput.classList.add('is-valid');
                confirmPasswordIcon.classList.remove('invalid-icon');
                confirmPasswordIcon.classList.add('valid-icon');
                confirmPasswordIcon.textContent = '✓';
            } else {
                confirmPasswordInput.classList.remove('is-valid');
                confirmPasswordInput.classList.add('is-invalid');
                confirmPasswordIcon.classList.remove('valid-icon');
                confirmPasswordIcon.classList.add('invalid-icon');
                confirmPasswordIcon.textContent = '✕';
            }
        }

        passwordInput.addEventListener('input', function() {
            updatePasswordStrength();
            validateConfirmPassword();
        });
        confirmPasswordInput.addEventListener('input', validateConfirmPassword);


        const inputsToValidate = [
            document.getElementById('ad'),
            document.getElementById('soyad'),
            document.getElementById('username'),
            document.getElementById('email'),
            document.getElementById('tc_no'),
            document.getElementById('adres'),
            document.getElementById('cinsiyet')
        ];

        function applyValidationAndIcon(inputElement) {
            const iconElement = inputElement.closest('.input-group').querySelector('.input-feedback-icon');
            if (!iconElement) return;

            if (inputElement.value.length === 0) {
                inputElement.classList.remove('is-valid', 'is-invalid');
                iconElement.classList.remove('valid-icon', 'invalid-icon');
                iconElement.textContent = '';
            } else if (inputElement.checkValidity()) {
                inputElement.classList.remove('is-invalid');
                inputElement.classList.add('is-valid');
                iconElement.classList.remove('invalid-icon');
                iconElement.classList.add('valid-icon');
                iconElement.textContent = '✓';
            } else {
                inputElement.classList.remove('is-valid');
                inputElement.classList.add('is-invalid');
                iconElement.classList.remove('valid-icon');
                iconElement.classList.add('invalid-icon');
                iconElement.textContent = '✕';
            }
        }

        inputsToValidate.forEach(input => {
            if (input) {
                input.addEventListener('input', function() {
                    applyValidationAndIcon(this);
                });
                if (input.tagName === 'SELECT') {
                    input.addEventListener('change', function() {
                        applyValidationAndIcon(this);
                    });
                }
            }
        });

        phoneInputField.addEventListener('input', function() {
            const inputElement = this;
            const iconElement = inputElement.closest('.input-group').querySelector('.input-feedback-icon');
            if (!iconElement) return;

            if (iti.isValidNumber()) {
                inputElement.classList.remove('is-invalid');
                inputElement.classList.add('is-valid');
                iconElement.classList.remove('invalid-icon');
                iconElement.classList.add('valid-icon');
                iconElement.textContent = '✓';
            } else {
                inputElement.classList.remove('is-valid');
                inputElement.classList.add('is-invalid');
                iconElement.classList.remove('valid-icon');
                iconElement.classList.add('invalid-icon');
                iconElement.textContent = '✕';
            }
            if (inputElement.value.length === 0) {
                inputElement.classList.remove('is-valid', 'is-invalid');
                iconElement.classList.remove('valid-icon', 'invalid-icon');
                iconElement.textContent = '';
            }
        });

        const dogumTarihiInput = document.getElementById('dogum_tarihi');

        function validateDogumTarihi() {
            const inputElement = dogumTarihiInput;
            const iconElement = inputElement.closest('.input-group').querySelector('.input-feedback-icon');
            if (!iconElement) return;

            if (inputElement.value.length === 0) {
                inputElement.classList.remove('is-valid', 'is-invalid');
                iconElement.classList.remove('valid-icon', 'invalid-icon');
                iconElement.textContent = '';
                return;
            }

            const birthDateStr = inputElement.value;
            const birthDate = new Date(birthDateStr);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }

            if (birthDate > today) {
                inputElement.classList.remove('is-valid');
                inputElement.classList.add('is-invalid');
                iconElement.classList.remove('valid-icon');
                iconElement.classList.add('invalid-icon');
                iconElement.textContent = '✕';
                return;
            }

            if (age < 18) {
                inputElement.classList.remove('is-valid');
                inputElement.classList.add('is-invalid');
                iconElement.classList.remove('valid-icon');
                iconElement.classList.add('invalid-icon');
                iconElement.textContent = '✕';
            } else {
                inputElement.classList.remove('is-invalid');
                inputElement.classList.add('is-valid');
                iconElement.classList.remove('invalid-icon');
                iconElement.classList.add('valid-icon');
                iconElement.textContent = '✓';
            }
        }

        dogumTarihiInput.addEventListener('input', validateDogumTarihi);
        dogumTarihiInput.addEventListener('change', validateDogumTarihi);

        document.addEventListener('DOMContentLoaded', function() {
            inputsToValidate.forEach(input => {
                if (input) {
                    applyValidationAndIcon(input);
                }
            });
            phoneInputField.dispatchEvent(new Event('input')); 
            passwordInput.dispatchEvent(new Event('input')); 
            validateDogumTarihi(); 
        });

        const registerForm = document.getElementById('registerForm');
        registerForm.addEventListener('submit', function(event) {
            const password = passwordInput.value;
            let strength = 0;
            if (password.length >= 8) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[a-z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) strength++;

            if (strength < 3) {
                event.preventDefault();
                flash('Şifreniz çok zayıf! Lütfen daha güçlü bir şifre belirleyin.', 'error');
                passwordInput.focus();
                return;
            }

            if (passwordInput.value !== confirmPasswordInput.value) {
                event.preventDefault();
                flash('Şifreler eşleşmiyor! Lütfen aynı şifreyi tekrar girin.', 'error');
                confirmPasswordInput.focus();
                return;
            }

            if (!iti.isValidNumber()) {
                event.preventDefault();
                flash('Lütfen geçerli bir telefon numarası giriniz.', 'error');
                phoneInputField.focus();
                return;
            }

            const birthDateStr = dogumTarihiInput.value;
            const birthDate = new Date(birthDateStr);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }

            if (birthDate > today) {
                event.preventDefault();
                flash('Doğum tarihi gelecekte olamaz.', 'error');
                dogumTarihiInput.focus();
                return;
            }
            if (age < 18) {
                event.preventDefault();
                flash('Kayıt olmak için 18 yaşından büyük olmalısınız.', 'error');
                dogumTarihiInput.focus();
                return;
            }

            const cinsiyetSelect = document.getElementById('cinsiyet');
            if (cinsiyetSelect.value === '') {
                event.preventDefault();
                flash('Lütfen bir cinsiyet seçin.', 'error');
                cinsiyetSelect.focus();
                return;
            }
            
            const recaptchaResponse = grecaptcha.getResponse();
            if (!recaptchaResponse) {
                event.preventDefault();
                flash('Lütfen reCAPTCHA doğrulamasını tamamlayın.', 'error');
                return;
            }
        });

        function flash(message, category) {
            const flashesDiv = document.querySelector('.flashes');
            if (flashesDiv) {
                flashesDiv.innerHTML = ''; 
                const li = document.createElement('li');
                li.className = category;
                li.textContent = message;
                flashesDiv.appendChild(li);
                setTimeout(() => {
                    li.remove();
                }, 5000);
            }
        }
        
        function togglePassword(id) {
            const input = document.getElementById(id);
            const toggle = input.closest(".password-group").querySelector(".toggle-password");
            const eyeIcon = toggle.querySelector(".eye-icon");
            const eyeOffIcon = toggle.querySelector(".eye-off-icon");
            
            if (input.type === "password") {
                input.type = "text";
                eyeIcon.style.display = "none";
                eyeOffIcon.style.display = "block";
                toggle.classList.add("active");
            } else {
                input.type = "password";
                eyeIcon.style.display = "block";
                eyeOffIcon.style.display = "none";
                toggle.classList.remove("active");
            }
        }

        // Harita Paneli ve Harita Fonksiyonları
        const mapPanel = document.getElementById('mapPanel');
        const showMapBtn = document.getElementById('showMapBtn');
        const closeMapBtn = document.getElementById('closeMapBtn');
        const findMeBtn = document.getElementById('findMeBtn');
        const mapAddressSearch = document.getElementById('mapAddressSearch');
        const searchMapBtn = document.getElementById('searchMapBtn');
        const foundAddressTextarea = document.getElementById('foundAddress');
        const selectAddressBtn = document.getElementById('selectAddressBtn');

        let map;
        let marker;

        showMapBtn.addEventListener('click', () => {
            mapPanel.classList.remove('hidden');
            if (!map) {
                map = L.map('map').setView([38.9637, 35.2433], 6); // Türkiye merkezli başlangıç görünümü
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(map);
                map.on('click', onMapClick);
            }
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
        });

        closeMapBtn.addEventListener('click', () => {
            mapPanel.classList.add('hidden');
        });

        selectAddressBtn.addEventListener('click', () => {
            const mainAddressInput = document.getElementById('adres');
            mainAddressInput.value = foundAddressTextarea.value;
            mapPanel.classList.add('hidden');
        });

        findMeBtn.addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const currentLatLng = [lat, lng];
                    
                    map.setView(currentLatLng, 15);
                    updateMarker(currentLatLng);
                    reverseGeocode(lat, lng);
                }, error => {
                    flash('Konumunuz bulunamadı: ' + error.message, 'error');
                });
            } else {
                flash('Tarayıcınız konum servislerini desteklemiyor.', 'error');
            }
        });
        
        searchMapBtn.addEventListener('click', () => {
            const address = mapAddressSearch.value;
            if (address) {
                geocode(address);
            }
        });

        function updateMarker(latlng) {
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker(latlng).addTo(map);
            marker.bindPopup("<b>Seçilen Konum</b>").openPopup();
        }

        async function reverseGeocode(lat, lng) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data && data.address) {
                    const address = data.display_name;
                    foundAddressTextarea.value = address;
                } else {
                    foundAddressTextarea.value = "Adres bulunamadı.";
                }
            } catch (error) {
                foundAddressTextarea.value = "Adres bulunurken bir hata oluştu.";
                console.error("Reverse geocoding hatası:", error);
            }
        }
        
        async function geocode(address) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lng = parseFloat(data[0].lon);
                    const latlng = [lat, lng];
                    
                    map.setView(latlng, 15);
                    updateMarker(latlng);
                    foundAddressTextarea.value = data[0].display_name;
                } else {
                    flash("Adres bulunamadı. Lütfen daha detaylı bir adres girin.", 'error');
                }
            } catch (error) {
                flash("Adres bulunurken bir hata oluştu.", 'error');
                console.error("Geocoding hatası:", error);
            }
        }
        
        function onMapClick(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            updateMarker(e.latlng);
            reverseGeocode(lat, lng);
        }
    </script>
</body>
</html>
