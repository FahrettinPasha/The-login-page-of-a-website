<!DOCTYPE html>
<html>
<head>
    <title>KayÄ±t Ol</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>
<body>
    <div class="container">
        <h1>KayÄ±t Formu</h1>
        {# Flash messages are displayed here #}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flashes">
                {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}
        <form action="/kayit" method="POST">
            <div class="input-group">
                <input type="text" id="ad" name="ad" placeholder="AdÄ±nÄ±z" required>
                <div class="input-feedback-icon"></div>
            </div>
            <div class="input-group">
                <input type="text" id="soyad" name="soyad" placeholder="SoyadÄ±nÄ±z" required>
                <div class="input-feedback-icon"></div>
            </div>
            <div class="input-group">
                <input type="text" id="username" name="username" placeholder="KullanÄ±cÄ± AdÄ±" required>
                <div class="input-feedback-icon"></div>
            </div>
            <div class="input-group">
                <input type="email" id="email" name="email" placeholder="E-posta" required>
                <div class="input-feedback-icon"></div>
            </div>
            <div class="input-group">
                <input type="password" id="sifre" name="sifre" placeholder="Åžifre (min 8 karakter, B/k harf, rakam, Ã¶zel)" required minlength="8">
                <div class="input-feedback-icon"></div>
            </div>
            <div id="password-strength-feedback" class="password-feedback hidden"></div> {# Hidden by default #}
            <div class="password-strength-bar-container hidden"> {# Hidden by default #}
                <div id="password-strength-bar" class="password-strength-bar"></div>
            </div>
            
            {# New structure for phone number #}
            <div class="phone-input-group input-group">
                <select id="country-code" class="country-code-select">
                    <option value="+90" selected>ðŸ‡¹ðŸ‡· +90</option>
                    <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
                    <option value="+44">ðŸ‡¬ðŸ‡§ +44</option>
                    <option value="+49">ðŸ‡©ðŸ‡ª +49</option>
                    {# More country codes can be added #}
                </select>
                <input type="tel" id="telefon" name="telefon" placeholder="Telefon NumarasÄ±" required pattern="[0-9]{10,15}" title="Telefon numarasÄ± sadece rakamlardan oluÅŸmalÄ± ve 10 ile 15 hane arasÄ±nda olmalÄ±dÄ±r.">
                <div class="input-feedback-icon"></div> {# Icon for phone #}
            </div>

            <div class="input-group">
                <input type="text" id="tc_no" name="tc_no" placeholder="TC Kimlik No (11 haneli)" required pattern="[0-9]{11}" title="TC Kimlik No 11 haneli olmalÄ± ve sadece rakamlardan oluÅŸmalÄ±dÄ±r.">
                <div class="input-feedback-icon"></div>
            </div>
            <div class="input-group">
                <input type="date" id="dogum_tarihi" name="dogum_tarihi" placeholder="DoÄŸum Tarihi" required>
                <div class="input-feedback-icon"></div>
            </div>
            <div class="input-group">
                <textarea id="adres" name="adres" placeholder="Adres"></textarea> {# Address textarea #}
                <div class="input-feedback-icon"></div>
            </div>
            <button type="submit">KayÄ±t Ol</button>
        </form>
        <p>Zaten hesabÄ±nÄ±z var? <a href="/giris">GiriÅŸ YapÄ±n</a></p>
    </div>

    <script>
        // JavaScript for password strength check
        const passwordInput = document.getElementById('sifre');
        const passwordFeedback = document.getElementById('password-strength-feedback');
        const passwordStrengthBarContainer = document.querySelector('.password-strength-bar-container');
        const passwordStrengthBar = document.getElementById('password-strength-bar');
        const passwordIcon = passwordInput.closest('.input-group').querySelector('.input-feedback-icon');

        passwordInput.addEventListener('input', function() {
            const password = this.value;
            
            // Hide bar and feedback if password is empty
            if (password.length === 0) {
                passwordFeedback.classList.add('hidden');
                passwordStrengthBarContainer.classList.add('hidden');
                passwordIcon.classList.remove('valid-icon', 'invalid-icon');
                passwordIcon.textContent = '';
                return; // Stop further processing
            } else {
                passwordFeedback.classList.remove('hidden');
                passwordStrengthBarContainer.classList.remove('hidden');
            }

            let strength = 0; // Score from 0-5
            let feedbackText = '';
            let feedbackClass = '';
            let barWidth = 0;

            const hasMinLength = password.length >= 8;
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasDigit = /[0-9]/.test(password);
            const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(password);

            if (hasMinLength) strength++;
            if (hasUpperCase) strength++;
            if (hasLowerCase) strength++;
            if (hasDigit) strength++;
            if (hasSpecialChar) strength++;

            if (strength < 3) {
                feedbackText = 'Åžifre Ã§ok zayÄ±f! (En az 8 karakter, B/k harf, rakam, Ã¶zel karakter iÃ§ermeli)';
                feedbackClass = 'weak';
                barWidth = (strength / 5) * 100;
                passwordIcon.classList.remove('valid-icon');
                passwordIcon.classList.add('invalid-icon');
                passwordIcon.textContent = 'âœ•'; // Red cross
            } else if (strength < 5) {
                feedbackText = 'Åžifre orta gÃ¼Ã§lÃ¼kte.';
                feedbackClass = 'medium';
                barWidth = (strength / 5) * 100;
                passwordIcon.classList.remove('valid-icon');
                passwordIcon.classList.add('invalid-icon');
                passwordIcon.textContent = 'âœ•'; // Red cross
            } else { // strength === 5
                feedbackText = 'Åžifre gÃ¼Ã§lÃ¼!';
                feedbackClass = 'strong';
                barWidth = 100;
                passwordIcon.classList.remove('invalid-icon');
                passwordIcon.classList.add('valid-icon');
                passwordIcon.textContent = 'âœ“'; // Green tick
            }

            passwordFeedback.textContent = feedbackText;
            passwordFeedback.className = 'password-feedback ' + feedbackClass;

            passwordStrengthBar.style.width = barWidth + '%';
            passwordStrengthBar.className = 'password-strength-bar ' + feedbackClass;
        });

        // General input validation and icon display
        const inputsToValidate = [
            document.getElementById('ad'),
            document.getElementById('soyad'),
            document.getElementById('username'),
            document.getElementById('email'),
            document.getElementById('telefon'),
            document.getElementById('tc_no'),
            document.getElementById('adres') // Birth date is handled separately
        ];

        function applyValidationAndIcon(inputElement) {
            const iconElement = inputElement.closest('.input-group').querySelector('.input-feedback-icon');
            if (!iconElement) return;

            if (inputElement.value.length === 0) {
                inputElement.classList.remove('is-valid', 'is-invalid');
                iconElement.classList.remove('valid-icon', 'invalid-icon');
                iconElement.textContent = '';
            } else if (inputElement.checkValidity()) {
                inputElement.classList.remove('is-invalid');
                inputElement.classList.add('is-valid');
                iconElement.classList.remove('invalid-icon');
                iconElement.classList.add('valid-icon');
                iconElement.textContent = 'âœ“'; // Green tick
            } else {
                inputElement.classList.remove('is-valid');
                inputElement.classList.add('is-invalid');
                iconElement.classList.remove('valid-icon');
                iconElement.classList.add('invalid-icon');
                iconElement.textContent = 'âœ•'; // Red cross
            }
        }

        inputsToValidate.forEach(input => {
            if (input) {
                input.addEventListener('input', function() {
                    applyValidationAndIcon(this);
                });
            }
        });

        // Special validation and icon display for birth date
        const dogumTarihiInput = document.getElementById('dogum_tarihi');

        function validateDogumTarihi() {
            const inputElement = dogumTarihiInput;
            const iconElement = inputElement.closest('.input-group').querySelector('.input-feedback-icon');
            if (!iconElement) return;

            if (inputElement.value.length === 0) {
                inputElement.classList.remove('is-valid', 'is-invalid');
                iconElement.classList.remove('valid-icon', 'invalid-icon');
                iconElement.textContent = '';
                return;
            }

            const birthDateStr = inputElement.value;
            const birthDate = new Date(birthDateStr);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }

            // Prevent future dates
            if (birthDate > today) {
                inputElement.classList.remove('is-valid');
                inputElement.classList.add('is-invalid');
                iconElement.classList.remove('valid-icon');
                iconElement.classList.add('invalid-icon');
                iconElement.textContent = 'âœ•';
                return;
            }

            // 18 years old check
            if (age < 18) {
                inputElement.classList.remove('is-valid');
                inputElement.classList.add('is-invalid');
                iconElement.classList.remove('valid-icon');
                iconElement.classList.add('invalid-icon');
                iconElement.textContent = 'âœ•';
            } else {
                inputElement.classList.remove('is-invalid');
                inputElement.classList.add('is-valid');
                iconElement.classList.remove('invalid-icon');
                iconElement.classList.add('valid-icon');
                iconElement.textContent = 'âœ“';
            }
        }

        dogumTarihiInput.addEventListener('input', validateDogumTarihi);
        dogumTarihiInput.addEventListener('change', validateDogumTarihi); // Check when date picker changes

        // JavaScript for phone country code selection
        const countryCodeSelect = document.getElementById('country-code');
        // displayCountryCode span is removed, no need for its JS part

        countryCodeSelect.addEventListener('change', function() {
            // The select element now directly displays the country code and flag
        });

        // Apply styles and icons for default values on page load
        document.addEventListener('DOMContentLoaded', function() {
            inputsToValidate.forEach(input => {
                if (input) {
                    applyValidationAndIcon(input);
                }
            });
            // passwordInput.dispatchEvent(new Event('input')); // Removed as bar is hidden initially
            // displayCountryCode.textContent = countryCodeSelect.value; // Removed
            validateDogumTarihi(); // Initial validation for birth date
        });
    </script>
</body>
</html>
